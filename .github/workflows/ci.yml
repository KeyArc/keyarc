name: CI

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "shared/**"
      - "frontend/**"
      - "pyproject.toml"
      - "**/Dockerfile"
      - "**/*.dockerfile"
      - "docker-compose*.yml"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main]
    paths:
      - "services/**"
      - "shared/**"
      - "frontend/**"
      - "pyproject.toml"
      - "**/Dockerfile"
      - "**/*.dockerfile"
      - "docker-compose*.yml"
      - ".github/workflows/ci.yml"

permissions:
  contents: read

# =============================================================================
# Configuration - Edit these values to customize CI behavior
# =============================================================================
env:
  # Language versions
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "20"

  # Python linting
  RUFF_VERSION: "0.14.14"
  RUFF_ARGS: "check --output-format=github"
  RUFF_FORMAT_ARGS: "format --check"
  MYPY_ARGS: "--ignore-missing-imports"

  # Docker linting (hadolint)
  # DL3008: Pin apt package versions
  # DL3013: Pin pip package versions
  # DL3018: Pin apk package versions
  HADOLINT_IGNORE: "DL3008,DL3013,DL3018"
  HADOLINT_FAILURE_THRESHOLD: "error"

jobs:
  # Detect which parts of the codebase changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      typescript: ${{ steps.filter.outputs.typescript }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'services/**/*.py'
              - 'shared/**/*.py'
              - 'pyproject.toml'
              - 'requirements*.txt'
            typescript:
              - 'frontend/**/*.ts'
              - 'frontend/**/*.html'
              - 'frontend/package.json'
              - 'frontend/tsconfig*.json'
              - 'frontend/.eslintrc*'
              - 'frontend/eslint.config.*'
            docker:
              - '**/Dockerfile'
              - '**/*.dockerfile'
              - 'docker-compose*.yml'

  # Python linting and type checking
  python-lint:
    name: Python Lint & Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Check if Python code exists
        id: check-python
        run: |
          if find services shared -name "*.py" 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.exists == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run Ruff linter
        if: steps.check-python.outputs.exists == 'true'
        uses: astral-sh/ruff-action@v3
        with:
          version: ${{ env.RUFF_VERSION }}
          args: ${{ env.RUFF_ARGS }}

      - name: Run Ruff formatter check
        if: steps.check-python.outputs.exists == 'true'
        uses: astral-sh/ruff-action@v3
        with:
          version: ${{ env.RUFF_VERSION }}
          args: ${{ env.RUFF_FORMAT_ARGS }}

      - name: Install mypy
        if: steps.check-python.outputs.exists == 'true'
        run: pip install mypy

      - name: Run mypy type checker
        if: steps.check-python.outputs.exists == 'true'
        run: mypy services shared ${{ env.MYPY_ARGS }}

      - name: Skip - No Python code found
        if: steps.check-python.outputs.exists == 'false'
        run: echo "No Python files found in services/ or shared/ - skipping lint"

  # TypeScript linting and type checking
  typescript-lint:
    name: TypeScript Lint & Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.typescript == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6

      - name: Check if frontend exists
        id: check-frontend
        run: |
          if [ -f "package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.check-frontend.outputs.exists == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        if: steps.check-frontend.outputs.exists == 'true'
        run: npm ci

      - name: Run ESLint
        if: steps.check-frontend.outputs.exists == 'true'
        run: npm run lint --if-present

      - name: Run TypeScript compiler check
        if: steps.check-frontend.outputs.exists == 'true'
        run: npx tsc --noEmit --skipLibCheck

      - name: Skip - No frontend found
        if: steps.check-frontend.outputs.exists == 'false'
        run: echo "No frontend/package.json found - skipping TypeScript lint"

  # Docker linting
  docker-lint:
    name: Docker Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Find Dockerfiles
        id: find-dockerfiles
        run: |
          files=$(find . -name "Dockerfile" -o -name "*.dockerfile" 2>/dev/null | tr '\n' ' ')
          if [ -n "$files" ]; then
            echo "files=$files" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run hadolint
        if: steps.find-dockerfiles.outputs.exists == 'true'
        uses: hadolint/hadolint-action@v3
        with:
          dockerfile: ${{ steps.find-dockerfiles.outputs.files }}
          ignore: ${{ env.HADOLINT_IGNORE }}
          failure-threshold: ${{ env.HADOLINT_FAILURE_THRESHOLD }}

      - name: Skip - No Dockerfiles found
        if: steps.find-dockerfiles.outputs.exists == 'false'
        run: echo "No Dockerfiles found - skipping Docker lint"

  # Summary job for branch protection
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, python-lint, typescript-lint, docker-lint]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Changes detection: ${{ needs.changes.result }}"
          echo "Python lint: ${{ needs.python-lint.result }}"
          echo "TypeScript lint: ${{ needs.typescript-lint.result }}"
          echo "Docker lint: ${{ needs.docker-lint.result }}"

          # Fail if changes detection failed
          if [ "${{ needs.changes.result }}" == "failure" ]; then
            echo "Changes detection failed"
            exit 1
          fi

          # Check Python lint (skipped is ok if no Python changes)
          if [ "${{ needs.python-lint.result }}" == "failure" ]; then
            echo "Python lint failed"
            exit 1
          fi

          # Check TypeScript lint (skipped is ok if no TS changes)
          if [ "${{ needs.typescript-lint.result }}" == "failure" ]; then
            echo "TypeScript lint failed"
            exit 1
          fi

          # Check Docker lint (skipped is ok if no Docker changes)
          if [ "${{ needs.docker-lint.result }}" == "failure" ]; then
            echo "Docker lint failed"
            exit 1
          fi

          echo "All checks passed!"
