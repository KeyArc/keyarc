name: auto-unblock-issues

on:
  issues:
    types: [closed]

jobs:
  unblock-dependent-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write

    steps:
      - name: Find and unblock dependent issues
        uses: actions/github-script@v7
        env:
          PROJECT_ID: PVT_kwDODzuJ-c4BNYGm
          STATUS_FIELD_ID: PVTSSF_lADODzuJ-c4BNYGmzg8Y71s
          READY_OPTION_ID: e5dd8d9b
          BLOCKED_OPTION_ID: a149a0a4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const closedIssueNumber = context.payload.issue.number;
            const closedIssueTitle = context.payload.issue.title;

            console.log(`Issue #${closedIssueNumber} was closed: ${closedIssueTitle}`);

            // Get all open issues in the repo
            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            console.log(`Found ${openIssues.length} open issues to check`);

            for (const issue of openIssues) {
              try {
                // Get blockers for this issue
                const { data: blockers } = await github.request(
                  'GET /repos/{owner}/{repo}/issues/{issue_number}/dependencies/blocked_by',
                  {
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number
                  }
                );

                if (!blockers || blockers.length === 0) continue;

                // Check if the closed issue was a blocker
                const wasBlockedByThis = blockers.some(b => b.number === closedIssueNumber);
                if (!wasBlockedByThis) continue;

                console.log(`Issue #${issue.number} was blocked by #${closedIssueNumber}`);

                // Check if any other blockers are still open
                const openBlockers = blockers.filter(b =>
                  b.number !== closedIssueNumber && b.state === 'open'
                );

                if (openBlockers.length > 0) {
                  console.log(`Issue #${issue.number} still has ${openBlockers.length} open blocker(s): ${openBlockers.map(b => '#' + b.number).join(', ')}`);
                  continue;
                }

                console.log(`Issue #${issue.number} is now fully unblocked!`);

                // Get project item ID for this issue
                const projectQuery = `
                  query($owner: String!, $repo: String!, $issueNumber: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $issueNumber) {
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                `;

                const projectResult = await github.graphql(projectQuery, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issueNumber: issue.number
                });

                const projectItems = projectResult.repository.issue.projectItems.nodes;
                const keyarcProjectItem = projectItems.find(item => item.project.id === process.env.PROJECT_ID);

                if (!keyarcProjectItem) {
                  console.log(`Issue #${issue.number} is not on the KeyArc project board`);
                  continue;
                }

                // Update status to "Ready"
                const mutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;

                await github.graphql(mutation, {
                  projectId: process.env.PROJECT_ID,
                  itemId: keyarcProjectItem.id,
                  fieldId: process.env.STATUS_FIELD_ID,
                  optionId: process.env.READY_OPTION_ID
                });

                console.log(`Moved issue #${issue.number} to Ready on project board`);

                // Add comment to the issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `**Unblocked:** Issue #${closedIssueNumber} was closed. This issue has no remaining open blockers and has been moved to Ready.`
                });

                console.log(`Added comment to issue #${issue.number}`);

              } catch (error) {
                console.log(`Error processing issue #${issue.number}: ${error.message}`);
              }
            }

            console.log('Done processing dependent issues');
